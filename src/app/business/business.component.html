<!-- src/app/components/business-registration/business-registration.component.html -->
<div class="business-registration-container">
  <!-- Not Signed In Message -->
  <div *ngIf="!data.currentUser" class="sign-in-message">
    <p-card>
      <ng-template pTemplate="content">
        <div class="message-content">
          <i class="pi pi-info-circle warning-icon" style="font-size: 3rem; color: var(--primary-color);"></i>
          <h2>Please Sign In</h2>
          <p>You need to be signed in to register your business.</p>
          <p-button label="Sign In" icon="pi pi-sign-in" [routerLink]="['/sign']" [queryParams]="{redirect: '/business/add'}"></p-button>
        </div>
      </ng-template>
    </p-card>
  </div>

  <!-- Business Registration Stepper -->
  <div *ngIf="data.currentUser" class="registration-content">
    <p-card class="stepper-card">
      <ng-template pTemplate="header">
        <div class="card-header-custom">
          <h2>Business Registration</h2>
          <p style="color: #ffffff; margin-top: 0.5rem;">Register your business in 10 minutes and start earning! <i class="pi pi-clock" style="color: #FFD700; margin-left: 8px; font-size: 1.2em;"></i></p>
        </div>
      </ng-template>

      <!-- AI Form Filling Section -->
      <ng-template pTemplate="content">
        <div class="ai-section">
          <p-button 
            [label]="showAISection ? 'Hide AI Assistant' : '✨AI Assistant✨'" 
            icon="pi pi-sparkles"
            (onClick)="toggleAISection()">
          </p-button>
          <div class="ai-input-container" *ngIf="showAISection">
            <div class="field">
              <textarea 
                pTextarea
                id="aiDescription"
                [(ngModel)]="aiDescription" 
                [placeholder]="getAIPlaceholder()"
                rows="3"
                class="w-full">
              </textarea>
            </div>
            <p-button 
              [label]="getAIButtonText()"
              icon="pi pi-sparkles"
              (onClick)="fillFormWithAI()" 
              [disabled]="isAILoading || !aiDescription.trim()"
              [loading]="isAILoading">
            </p-button>
          </div>
          <p-divider *ngIf="showAISection"></p-divider>
        </div>

        <!-- PrimeNG Steps -->
        <p-steps [model]="stepItems" [readonly]="true" [activeIndex]="currentStep" class="custom-steps"></p-steps>

        <!-- Step Content -->
        <div class="step-content">
          
          <!-- Step 1: Basic Information -->
          <div *ngIf="currentStep === 0" class="step-form">
            <form [formGroup]="basicInfoForm">
              <h3><i class="pi pi-building"></i> Business Information</h3>
              
              <div class="formgrid grid">
                <div class="field col-12">
                  <p-floatLabel>
                    <input 
                      pInputText 
                      id="bussinessName"
                      formControlName="bussinessName" 
                      class="w-full"
                      [class.ng-invalid]="basicInfoForm.get('bussinessName')?.invalid && basicInfoForm.get('bussinessName')?.touched"/>
                    <label for="bussinessName">Business Name <span class="required">*</span></label>
                  </p-floatLabel>
                  <small 
                    class="p-error" 
                    *ngIf="basicInfoForm.get('bussinessName')?.hasError('required') && basicInfoForm.get('bussinessName')?.touched">
                    Business name is required
                  </small>
                  <small 
                    class="p-error" 
                    *ngIf="basicInfoForm.get('bussinessName')?.hasError('minlength') && basicInfoForm.get('bussinessName')?.touched">
                    Business name must be at least 2 characters
                  </small>
                </div>

                <div class="field col-12">
                  <p-floatLabel>
                    <textarea 
                      pTextarea
                      id="bussinessDescription"
                      formControlName="bussinessDescription" 
                      rows="4"
                      class="w-full"
                      [class.ng-invalid]="basicInfoForm.get('bussinessDescription')?.invalid && basicInfoForm.get('bussinessDescription')?.touched">
                    </textarea>
                    <label for="bussinessDescription">Business Description <span class="required">*</span></label>
                  </p-floatLabel>
                  <small 
                    class="p-error" 
                    *ngIf="basicInfoForm.get('bussinessDescription')?.hasError('required') && basicInfoForm.get('bussinessDescription')?.touched">
                    Business description is required
                  </small>
                </div>

                <div class="field col-12 md:col-6">
                  <p-floatLabel>
                    <input 
                      pInputText 
                      id="bussinessPhone"
                      formControlName="bussinessPhone" 
                      class="w-full"
                      [class.ng-invalid]="basicInfoForm.get('bussinessPhone')?.invalid && basicInfoForm.get('bussinessPhone')?.touched"/>
                    <label for="bussinessPhone">Business Phone <span class="required">*</span></label>
                  </p-floatLabel>
                  <small 
                    class="p-error" 
                    *ngIf="basicInfoForm.get('bussinessPhone')?.hasError('required') && basicInfoForm.get('bussinessPhone')?.touched">
                    Phone number is required
                  </small>
                  <small 
                    class="p-error" 
                    *ngIf="basicInfoForm.get('bussinessPhone')?.hasError('pattern') && basicInfoForm.get('bussinessPhone')?.touched">
                    Please enter a valid phone number
                  </small>
                </div>

                <div class="field col-12 md:col-6">
                  <p-floatLabel>
                    <input 
                      pInputText 
                      id="bussinessEmail"
                      formControlName="bussinessEmail" 
                      type="email"
                      class="w-full"
                      [class.ng-invalid]="basicInfoForm.get('bussinessEmail')?.invalid && basicInfoForm.get('bussinessEmail')?.touched"/>
                    <label for="bussinessEmail">Business Email <span class="required">*</span></label>
                  </p-floatLabel>
                  <small 
                    class="p-error" 
                    *ngIf="basicInfoForm.get('bussinessEmail')?.hasError('required') && basicInfoForm.get('bussinessEmail')?.touched">
                    Business email is required
                  </small>
                  <small 
                    class="p-error" 
                    *ngIf="basicInfoForm.get('bussinessEmail')?.hasError('email') && basicInfoForm.get('bussinessEmail')?.touched">
                    Please enter a valid email address
                  </small>
                </div>

                <div class="field col-12">
                  <p-floatLabel>
                    <input 
                      pInputText 
                      id="ownerEmail"
                      formControlName="ownerEmail" 
                      [readonly]="true"
                      class="w-full"/>
                    <label for="ownerEmail">Owner Email</label>
                  </p-floatLabel>
                </div>

                <!-- Business Type Selection -->
                <div class="field col-12">
                  <label>Business Operation Type <span class="required">*</span></label>
                  <div class="operation-type-selection">
                    <p-radioButton 
                      name="operationType" 
                      value="solo" 
                      formControlName="operationType" 
                      inputId="solo">
                    </p-radioButton>
                    <label for="solo" class="ml-2 mr-4">I work alone</label>
                    
                    <p-radioButton 
                      name="operationType" 
                      value="with_staff" 
                      formControlName="operationType" 
                      inputId="with_staff">
                    </p-radioButton>
                    <label for="with_staff" class="ml-2">I work with staff</label>
                  </div>
                  <small class="p-hint">Choose whether you work alone or have team members</small>
                </div>

                <!-- Staff Section (Conditional) -->
                <div *ngIf="showStaffSection" class="field col-12">
                  <p-divider></p-divider>
                  <h4><i class="pi pi-users"></i> Staff Management</h4>
                  <p class="staff-description">Add team members who will help provide services. You can manage their access levels and roles.</p>

                  <!-- Staff Form -->
                  <p-card class="staff-form-card mt-3">
                    <ng-template pTemplate="header">
                      <div class="card-header-title">
                        {{ editingStaffIndex !== null ? 'Edit Staff Member' : 'Add Staff Member' }}
                      </div>
                    </ng-template>
                    <ng-template pTemplate="content">
                      <form [formGroup]="staffForm" class="formgrid grid">
                        <div class="field col-12 md:col-6">
                          <p-floatLabel>
                            <input 
                              pInputText 
                              id="firstName"
                              formControlName="firstName" 
                              maxlength="2000"
                              class="w-full"/>
                            <label for="firstName">First Name <span class="required">*</span></label>
                          </p-floatLabel>
                          <small class="p-error" *ngIf="staffForm.get('firstName')?.hasError('required') && staffForm.get('firstName')?.touched">
                            First name is required
                          </small>
                        </div>

                        <div class="field col-12 md:col-6">
                          <p-floatLabel>
                            <input 
                              pInputText 
                              id="lastName"
                              formControlName="lastName" 
                              maxlength="2000"
                              class="w-full"/>
                            <label for="lastName">Last Name <span class="required">*</span></label>
                          </p-floatLabel>
                          <small class="p-error" *ngIf="staffForm.get('lastName')?.hasError('required') && staffForm.get('lastName')?.touched">
                            Last name is required
                          </small>
                        </div>

                        <div class="field col-12 md:col-6">
                          <p-floatLabel>
                            <input 
                              pInputText 
                              id="staffEmail"
                              formControlName="email" 
                              type="email"
                              maxlength="2000"
                              class="w-full"/>
                            <label for="staffEmail">Email <span class="required">*</span></label>
                          </p-floatLabel>
                          <small class="p-error" *ngIf="staffForm.get('email')?.hasError('required') && staffForm.get('email')?.touched">
                            Email is required
                          </small>
                          <small class="p-error" *ngIf="staffForm.get('email')?.hasError('email') && staffForm.get('email')?.touched">
                            Please enter a valid email address
                          </small>
                        </div>

                        <div class="field col-12 md:col-6">
                          <p-floatLabel>
                            <input 
                              pInputText 
                              id="role"
                              formControlName="role" 
                              class="w-full"/>
                            <label for="role">Role <span class="required">*</span></label>
                          </p-floatLabel>
                          <small class="p-error" *ngIf="staffForm.get('role')?.hasError('required') && staffForm.get('role')?.touched">
                            Role is required
                          </small>
                        </div>

                        <div class="field col-12">
                          <div class="flex align-items-center">
                            <p-checkbox 
                              formControlName="accessAll" 
                              [binary]="true" 
                              inputId="accessAll">
                            </p-checkbox>
                            <label for="accessAll" class="ml-2">
                              <strong>Full Access</strong>
                              <p class="checkbox-description m-0">Allow this staff member to access all business functions and data</p>
                            </label>
                          </div>
                        </div>
                      </form>
                    </ng-template>
                    <ng-template pTemplate="footer">
                      <p-button 
                        [label]="editingStaffIndex !== null ? 'Update Staff Member' : 'Add Staff Member'"
                        icon="pi pi-plus"
                        (onClick)="addStaffMember()" 
                        [disabled]="!staffForm.valid">
                      </p-button>
                      <p-button 
                        *ngIf="editingStaffIndex !== null"
                        label="Cancel"
                        icon="pi pi-times"
                        severity="secondary"
                        (onClick)="cancelStaffEdit()">
                      </p-button>
                    </ng-template>
                  </p-card>

                  <!-- Staff List -->
                  <div class="staff-list mt-4" *ngIf="staffMembers.length > 0">
                    <h4><i class="pi pi-users"></i> Staff Members ({{ getStaffSummary() }})</h4>
                    <div class="staff-grid">
                      <p-card *ngFor="let staff of staffMembers; let i = index" class="staff-card" 
                              [ngClass]="{'inactive': !staff.isActive}">
                        <ng-template pTemplate="header">
                          <div class="staff-card-header">
                            <h5>{{ staff.firstName }} {{ staff.lastName }}</h5>
                            <p class="staff-role">{{ staff.role }}</p>
                          </div>
                        </ng-template>
                        <ng-template pTemplate="content">
                          <p><i class="pi pi-envelope mr-2"></i> {{ staff.email }}</p>
                          <div class="staff-badges mt-2">
                            <p-chip 
                              [label]="staff.accessAll ? 'Full Access' : 'Limited Access'"
                              [styleClass]="staff.accessAll ? 'custom-chip-primary' : 'custom-chip-secondary'">
                            </p-chip>
                            <p-chip 
                              [label]="staff.isActive ? 'Active' : 'Inactive'"
                              [styleClass]="staff.isActive ? 'custom-chip-success' : 'custom-chip-danger'">
                            </p-chip>
                          </div>
                        </ng-template>
                        <ng-template pTemplate="footer">
                          <div class="flex gap-2">
                            <p-button 
                              icon="pi pi-pencil" 
                              severity="secondary"
                              size="small"
                              (onClick)="editStaffMember(i)" 
                              pTooltip="Edit staff member">
                            </p-button>
                            <p-button 
                              [icon]="staff.isActive ? 'pi pi-user-minus' : 'pi pi-user-plus'"
                              [severity]="staff.isActive ? 'danger' : 'success'"
                              size="small"
                              (onClick)="toggleStaffActive(i)"
                              [pTooltip]="staff.isActive ? 'Deactivate staff member' : 'Activate staff member'">
                            </p-button>
                            <p-button 
                              icon="pi pi-trash" 
                              severity="danger"
                              size="small"
                              (onClick)="deleteStaffMember(i)" 
                              pTooltip="Remove staff member">
                            </p-button>
                          </div>
                        </ng-template>
                      </p-card>
                    </div>
                  </div>

                  <div *ngIf="staffMembers.length === 0" class="no-staff-message">
                    <i class="pi pi-users" style="font-size: 3rem; color: var(--text-color-secondary);"></i>
                    <p>No staff members added yet. Add your first team member above.</p>
                    <p class="note">You can add staff members later if you're unsure right now.</p>
                  </div>
                </div>
              </div>
            </form>
          </div>

          <!-- Step 2: Services -->
          <div *ngIf="currentStep === 1" class="step-form">
            <div class="services-section">
              <h3><i class="pi pi-briefcase"></i> Business Services</h3>
              
              <!-- Service Form -->
              <p-card class="form-card">
                <ng-template pTemplate="header">
                  <div class="card-header-title">
                    {{ editingServiceId ? 'Edit Service' : 'Add New Service' }}
                  </div>
                </ng-template>
                <ng-template pTemplate="content">
                  <form [formGroup]="serviceForm" class="formgrid grid">
                    <div class="field col-12 md:col-6">
                      <p-floatLabel>
                        <input 
                          pInputText 
                          id="serviceName"
                          formControlName="serviceName" 
                          class="w-full"/>
                        <label for="serviceName">Service Name <span class="required">*</span></label>
                      </p-floatLabel>
                      <small class="p-error" *ngIf="serviceForm.get('serviceName')?.hasError('required') && serviceForm.get('serviceName')?.touched">
                        Service name is required
                      </small>
                    </div>

                    <div class="field col-12 md:col-6">
                      <label class="field-label">Duration (minutes) <span class="required">*</span></label>
                      <p-inputNumber 
                        id="duration"
                        formControlName="duration" 
                        [showButtons]="true"
                        [min]="5"
                        [step]="5"
                        suffix=" min"
                        placeholder="30"
                        class="w-full">
                      </p-inputNumber>
                      <small class="p-error" *ngIf="serviceForm.get('duration')?.hasError('required') && serviceForm.get('duration')?.touched">
                        Duration is required
                      </small>
                      <small class="p-error" *ngIf="serviceForm.get('duration')?.hasError('min') && serviceForm.get('duration')?.touched">
                        Duration must be at least 5 minutes
                      </small>
                    </div>

                    <div class="field col-12">
                      <p-floatLabel>
                        <textarea 
                          pTextarea
                          id="serviceDescription"
                          formControlName="serviceDescription" 
                          rows="3"
                          class="w-full">
                        </textarea>
                        <label for="serviceDescription">Service Description <span class="required">*</span></label>
                      </p-floatLabel>
                      <small class="p-error" *ngIf="serviceForm.get('serviceDescription')?.hasError('required') && serviceForm.get('serviceDescription')?.touched">
                        Service description is required
                      </small>
                    </div>

                    <div class="field col-12 md:col-6">
                      <label class="field-label">Price <span class="required">*</span></label>
                      <p-inputNumber 
                        id="servicePrice"
                        formControlName="servicePrice" 
                        mode="currency"
                        [currency]="serviceForm.get('servicePriceCurrencyUnit')?.value || 'USD'"
                        locale="en-US"
                        [min]="0"
                        placeholder="0.00"
                        class="w-full">
                      </p-inputNumber>
                      <small class="p-error" *ngIf="serviceForm.get('servicePrice')?.hasError('required') && serviceForm.get('servicePrice')?.touched">
                        Price is required
                      </small>
                    </div>

                    <div class="field col-12 md:col-6">
                      <label class="field-label">Currency <span class="required">*</span></label>
                      <p-dropdown 
                        id="servicePriceCurrencyUnit"
                        formControlName="servicePriceCurrencyUnit"
                        [options]="currencies"
                        placeholder="Select Currency"
                        class="w-full">
                      </p-dropdown>
                    </div>

                    <div class="field col-12">
                      <p-floatLabel>
                        <input 
                          pInputText 
                          id="serviceImageUrl"
                          formControlName="serviceImageUrl" 
                          class="w-full"/>
                        <label for="serviceImageUrl">Image URL (optional)</label>
                      </p-floatLabel>
                    </div>
                  </form>
                </ng-template>
                <ng-template pTemplate="footer">
                  <p-button 
                    [label]="editingServiceId ? 'Update Service' : 'Add Service'"
                    icon="pi pi-plus"
                    (onClick)="addService()" 
                    [disabled]="!serviceForm.valid">
                  </p-button>
                  <p-button 
                    *ngIf="editingServiceId"
                    label="Cancel"
                    icon="pi pi-times"
                    severity="secondary"
                    (onClick)="editingServiceId = null; serviceForm.reset()">
                  </p-button>
                </ng-template>
              </p-card>

              <!-- Services List -->
              <div class="services-list mt-4" *ngIf="registration.services.length > 0">
                <h4><i class="pi pi-list"></i> Added Services ({{ registration.services.length }})</h4>
                <div class="services-grid">
                  <p-card *ngFor="let service of registration.services" class="service-card">
                    <ng-template pTemplate="header">
                      <div class="service-card-header">
                        <h5>{{ service.serviceName || 'Unnamed Service' }}</h5>
                        <p class="service-details">
                          <i class="pi pi-clock mr-1"></i> {{ service.serviceEstimatedTime || '30 minutes' }} • 
                          <i class="pi pi-dollar ml-2 mr-1"></i> {{ service.servicePrice !== undefined && service.servicePrice !== null ? service.servicePrice : 0 }} {{ service.servicePriceCurrencyUnit || 'USD' }}
                        </p>
                      </div>
                    </ng-template>
                    <ng-template pTemplate="content">
                      <p>{{ service.serviceDescription || 'No description provided.' }}</p>
                    </ng-template>
                    <ng-template pTemplate="footer">
                      <div class="flex gap-2">
                        <p-button 
                          icon="pi pi-pencil" 
                          severity="secondary"
                          size="small"
                          (onClick)="editService(service)">
                        </p-button>
                        <p-button 
                          icon="pi pi-trash" 
                          severity="danger"
                          size="small"
                          (onClick)="deleteService(service.serviceID!)">
                        </p-button>
                      </div>
                    </ng-template>
                  </p-card>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 3: Places -->
          <div *ngIf="currentStep === 2" class="step-form">
            <div class="places-section">
              <h3><i class="pi pi-map-marker"></i> Business Locations</h3>
              
              <!-- Location Type Selection -->
              <p-card class="form-card location-type-card">
                <ng-template pTemplate="header">
                  <div class="card-header-title">
                    <i class="pi pi-map"></i> Location Type
                  </div>
                  <p class="card-subtitle">Choose how you provide services to customers</p>
                </ng-template>
                <ng-template pTemplate="content">
                  <div class="location-type-selection">
                    <div *ngFor="let option of locationTypeOptions" class="location-type-option">
                      <p-radioButton 
                        name="locationType" 
                        [value]="option.value" 
                        [(ngModel)]="locationType"
                        (ngModelChange)="setLocationType($event)"
                        [inputId]="'loc_' + option.value">
                      </p-radioButton>
                      <label [for]="'loc_' + option.value" class="ml-2">
                        <h4>{{ option.label }}</h4>
                        <p>{{ option.description }}</p>
                      </label>
                    </div>
                  </div>
                </ng-template>
              </p-card>
              
              <!-- Google Maps Integration -->
              <p-accordion class="mt-3">
                <p-accordionTab header="Search Location on Google Maps" [iconPos]="'start'">
                  <ng-template pTemplate="header">
                    <i class="pi pi-map mr-2"></i>
                    <span>Search Location on Google Maps</span>
                  </ng-template>
                  <ng-template pTemplate="content">
                    <div class="maps-content">
                      <p class="maps-instruction">
                        Use the map below to search for your business address or service area. 
                        You can search, zoom, and navigate to find the exact location, then manually enter the details in the form below.
                      </p>
                      
                      <div class="maps-iframe-container">
                        <iframe 
                          src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d387190.2799160891!2d-74.25987368715491!3d40.697670063849574!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x89c24fa5d33f083b%3A0xc80b8f06e177fe62!2sNew%20York%2C%20NY%2C%20USA!5e0!3m2!1sen!2sus!4v1635959999999!5m2!1sen!2sus"
                          width="100%" 
                          height="400" 
                          style="border:0; border-radius: 8px;" 
                          allowfullscreen="" 
                          loading="lazy" 
                          referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                      </div>
                      
                      <div class="maps-help mt-3">
                        <i class="pi pi-info-circle"></i>
                        <span class="ml-2">Use the search box in the map above to find your location, then fill out the address form below.</span>
                      </div>
                    </div>
                  </ng-template>
                </p-accordionTab>
              </p-accordion>

              <!-- Manual Place Form -->
              <p-card class="form-card mt-3">
                <ng-template pTemplate="header">
                  <div class="card-header-title">
                    <i class="pi pi-pencil"></i> {{ editingPlaceId ? 'Edit Place' : 'Add Place Manually' }}
                  </div>
                  <p class="card-subtitle">Or enter address details manually</p>
                </ng-template>
                <ng-template pTemplate="content">
                  <div class="field">
                    <label for="placeType">Place Type</label>
                    <p-dropdown 
                      id="placeType"
                      [(ngModel)]="placeType" 
                      [options]="[
                        {label: 'Specific Address', value: 'specific'},
                        {label: 'Area Specification', value: 'area'}
                      ]"
                      optionLabel="label"
                      optionValue="value"
                      placeholder="Select Place Type"
                      class="w-full">
                    </p-dropdown>
                  </div>

                  <form [formGroup]="specificPlaceForm" class="formgrid grid" *ngIf="placeType === 'specific'">
                    <div class="field col-12 md:col-6">
                      <p-floatLabel>
                        <input 
                          pInputText 
                          id="streetAdr"
                          formControlName="streetAdr" 
                          class="w-full"/>
                        <label for="streetAdr">Street Address <span class="required">*</span></label>
                      </p-floatLabel>
                    </div>
                    <div class="field col-12 md:col-6">
                      <p-floatLabel>
                        <input 
                          pInputText 
                          id="city"
                          formControlName="city" 
                          class="w-full"/>
                        <label for="city">City <span class="required">*</span></label>
                      </p-floatLabel>
                    </div>
                    <div class="field col-12 md:col-6">
                      <p-floatLabel>
                        <input 
                          pInputText 
                          id="state"
                          formControlName="state" 
                          class="w-full"/>
                        <label for="state">State/Province <span class="required">*</span></label>
                      </p-floatLabel>
                    </div>
                    <div class="field col-12 md:col-6">
                      <label class="field-label">Country <span class="required">*</span></label>
                      <p-dropdown 
                        id="country"
                        formControlName="country"
                        [options]="countries"
                        placeholder="Select Country"
                        class="w-full">
                      </p-dropdown>
                    </div>
                    <div class="field col-12 md:col-6">
                      <p-floatLabel>
                        <input 
                          pInputText 
                          id="suburbPostcode"
                          formControlName="suburbPostcode" 
                          class="w-full"/>
                        <label for="suburbPostcode">Suburb/Postcode</label>
                      </p-floatLabel>
                    </div>
                  </form>

                  <form [formGroup]="areaPlaceForm" class="formgrid grid" *ngIf="placeType === 'area'">
                    <div class="field col-12 md:col-6">
                      <label class="field-label">Country <span class="required">*</span></label>
                      <p-dropdown 
                        id="areaCountry"
                        formControlName="country"
                        [options]="countries"
                        placeholder="Select Country"
                        class="w-full">
                      </p-dropdown>
                    </div>
                    <div class="field col-12 md:col-6">
                      <p-floatLabel>
                        <input 
                          pInputText 
                          id="areaState"
                          formControlName="state" 
                          class="w-full"/>
                        <label for="areaState">State/Province</label>
                      </p-floatLabel>
                    </div>
                    <div class="field col-12 md:col-6">
                      <p-floatLabel>
                        <input 
                          pInputText 
                          id="areaCity"
                          formControlName="city" 
                          class="w-full"/>
                        <label for="areaCity">City</label>
                      </p-floatLabel>
                    </div>
                    <div class="field col-12 md:col-6">
                      <p-floatLabel>
                        <input 
                          pInputText 
                          id="areaSuburbPostcode"
                          formControlName="suburbPostcode" 
                          class="w-full"/>
                        <label for="areaSuburbPostcode">Suburb/Postcode</label>
                      </p-floatLabel>
                    </div>
                  </form>
                </ng-template>
                <ng-template pTemplate="footer">
                  <p-button 
                    [label]="editingPlaceId ? 'Update Place' : 'Add Place'"
                    icon="pi pi-plus"
                    (onClick)="addPlace()" 
                    [disabled]="(placeType === 'specific' && !specificPlaceForm.valid) || (placeType === 'area' && !areaPlaceForm.valid)">
                  </p-button>
                  <p-button 
                    *ngIf="editingPlaceId"
                    label="Cancel"
                    icon="pi pi-times"
                    severity="secondary"
                    (onClick)="editingPlaceId = null; specificPlaceForm.reset(); areaPlaceForm.reset()">
                  </p-button>
                </ng-template>
              </p-card>

              <!-- Places List -->
              <div class="places-list-section mt-4">
                <h4><i class="pi pi-map-marker"></i> Specific Address Locations</h4>
                <div class="places-grid">
                  <p-card *ngFor="let place of getSpecificLocationPlaces()" class="place-card">
                    <ng-template pTemplate="header">
                      <div class="place-card-header">
                        <h5>{{ place.placeName }}</h5>
                        <p>{{ place.placeCity }}, {{ place.placeState }}</p>
                      </div>
                    </ng-template>
                    <ng-template pTemplate="content">
                      <p><i class="pi pi-map mr-2"></i>{{ place.placeZipCode }}</p>
                    </ng-template>
                    <ng-template pTemplate="footer">
                      <div class="flex gap-2">
                        <p-button 
                          icon="pi pi-pencil" 
                          severity="secondary"
                          size="small"
                          (onClick)="editSpecificPlace(getSpecificPlaceById(place.placeID)!)" 
                          [disabled]="!getSpecificPlaceById(place.placeID)">
                        </p-button>
                        <p-button 
                          icon="pi pi-trash" 
                          severity="danger"
                          size="small"
                          (onClick)="deleteSpecificPlace(getSpecificPlaceById(place.placeID)!)"
                          [disabled]="!getSpecificPlaceById(place.placeID)">
                        </p-button>
                      </div>
                    </ng-template>
                  </p-card>
                </div>

                <h4 class="mt-4"><i class="pi pi-globe"></i> Area Specification Locations</h4>
                <div class="places-grid">
                  <p-card *ngFor="let place of getAreaSpecificationPlaces()" class="place-card">
                    <ng-template pTemplate="header">
                      <div class="place-card-header">
                        <h5>{{ place.placeName }}</h5>
                        <p>{{ place.placeCity }}, {{ place.placeState }}</p>
                      </div>
                    </ng-template>
                    <ng-template pTemplate="content">
                      <p><i class="pi pi-map mr-2"></i>{{ place.placeZipCode }}</p>
                    </ng-template>
                    <ng-template pTemplate="footer">
                      <div class="flex gap-2">
                        <p-button 
                          icon="pi pi-pencil" 
                          severity="secondary"
                          size="small"
                          (onClick)="editAreaPlace(getAreaPlaceById(place.placeID)!)"
                          [disabled]="!getAreaPlaceById(place.placeID)">
                        </p-button>
                        <p-button 
                          icon="pi pi-trash" 
                          severity="danger"
                          size="small"
                          (onClick)="deleteAreaPlace(getAreaPlaceById(place.placeID)!)"
                          [disabled]="!getAreaPlaceById(place.placeID)">
                        </p-button>
                      </div>
                    </ng-template>
                  </p-card>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 4: Business Schedules (Already using PrimeNG) -->
          <div *ngIf="currentStep === 3" class="step-form">
            <div class="schedules-section">
              <div class="schedule-header">
                <h3><i class="pi pi-calendar"></i> Business Operating Hours</h3>
                <p>Set your business hours so customers know when you're available</p>
              </div>
              
              <!-- Quick Setup -->
              <div class="quick-setup-section" *ngIf="businessSchedules.length === 0">
                <p-card class="quick-setup-card">
                  <ng-template pTemplate="header">
                    <div class="quick-setup-header">
                      <i class="pi pi-clock"></i>
                      <span>Quick Setup</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="content">
                    <div class="quick-setup-content">
                      <p>Choose a common schedule to get started quickly:</p>
                      <div class="quick-options">
                        <p-button 
                          label="Standard Business Hours" 
                          icon="pi pi-briefcase" 
                          (onClick)="addStandardSchedule()"
                          class="p-button-lg">
                        </p-button>
                        <small>Monday - Friday, 9:00 AM - 5:00 PM</small>
                      </div>
                      <p-divider align="center">
                        <span class="or-text">or</span>
                      </p-divider>
                      <div class="custom-option">
                        <p-button 
                          label="Create Custom Schedule" 
                          icon="pi pi-plus" 
                          severity="secondary"
                          (onClick)="showCustomScheduleForm = true">
                        </p-button>
                      </div>
                    </div>
                  </ng-template>
                </p-card>
              </div>

              <!-- Current Schedules Timeline -->
              <div class="schedules-display" *ngIf="businessSchedules.length > 0">
                <div class="schedules-header">
                  <h4><i class="pi pi-list"></i> Your Business Hours</h4>
                  <p-button 
                    icon="pi pi-plus" 
                    label="Add Another Schedule"
                    size="small"
                    (onClick)="showCustomScheduleForm = true">
                  </p-button>
                </div>

                <!-- Beautiful Timeline Display -->
                <div class="schedule-timeline-container">
                  <div class="schedule-timeline">
                    <p-card 
                      *ngFor="let schedule of businessSchedules; let i = index" 
                      class="schedule-timeline-card">
                      
                      <ng-template pTemplate="header">
                        <div class="schedule-card-header">
                          <div class="schedule-title">
                            <i class="pi pi-calendar-clock"></i>
                            <span>{{ getScheduleTypeName(schedule.cycleType) }}</span>
                          </div>
                          <div class="schedule-actions">
                            <p-button 
                              icon="pi pi-pencil" 
                              size="small" 
                              text="true"
                              (onClick)="editSchedule(i)">
                            </p-button>
                            <p-button 
                              icon="pi pi-trash" 
                              size="small" 
                              text="true"
                              severity="danger"
                              (onClick)="deleteSchedule(i)">
                            </p-button>
                          </div>
                        </div>
                      </ng-template>
                      
                      <ng-template pTemplate="content">
                        <div class="schedule-card-content">
                          <div class="schedule-info">
                            <div class="info-row">
                              <i class="pi pi-calendar"></i>
                              <span>Starts: {{ schedule.cycleStartDate | date:'mediumDate' }}</span>
                            </div>
                            <div class="info-row">
                              <i class="pi pi-refresh"></i>
                              <span>Repeats every {{ schedule.cycleLengthInDays }} days</span>
                            </div>
                          </div>
                          
                          <!-- Days Preview -->
                          <div class="days-preview" *ngIf="schedule.cycles?.[0]?.days">
                            <div class="days-grid">
                              <div 
                                class="day-chip" 
                                *ngFor="let day of schedule.cycles[0].days"
                                [class.closed]="day.availabilityStatus === DayAvailabilityStatus.Unavailable">
                                <div class="day-name">{{ getDayAbbreviation(day.day) }}</div>
                                <div class="day-time" *ngIf="day.availabilityStatus === DayAvailabilityStatus.SpecificHours && day.openingPeriods[0]">
                                  {{ formatTime(day.openingPeriods[0].openingTime) }}-{{ formatTime(day.openingPeriods[0].closingTime) }}
                                </div>
                                <div class="day-time" *ngIf="day.availabilityStatus === DayAvailabilityStatus.Open24Hours">
                                  24h
                                </div>
                                <div class="day-time closed-text" *ngIf="day.availabilityStatus === DayAvailabilityStatus.Unavailable">
                                  Closed
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </ng-template>
                    </p-card>
                  </div>
                </div>
              </div>

              <!-- Custom Schedule Form -->
              <div class="custom-schedule-form" *ngIf="showCustomScheduleForm">
                <p-card>
                  <ng-template pTemplate="header">
                    <div class="form-header">
                      <i class="pi pi-plus-circle"></i>
                      <span>{{ editingScheduleIndex !== null ? 'Edit Schedule' : 'Create Custom Schedule' }}</span>
                    </div>
                  </ng-template>
                  
                  <ng-template pTemplate="content">
                    <div class="simple-schedule-form">
                      <div class="form-grid">
                        <!-- Schedule Name -->
                        <div class="form-field">
                          <label>Schedule Name</label>
                          <input 
                            pInputText 
                            [(ngModel)]="currentSchedule.name"
                            placeholder="e.g., Summer Hours, Weekend Schedule"
                            class="w-full">
                        </div>

                        <!-- Schedule Type -->
                        <div class="form-field">
                          <label>How often does this repeat?</label>
                          <p-dropdown 
                            [options]="scheduleTypeOptions" 
                            [(ngModel)]="currentSchedule.cycleType"
                            optionLabel="label" 
                            optionValue="value"
                            placeholder="Select schedule type"
                            class="w-full">
                          </p-dropdown>
                        </div>
                      </div>

                      <!-- Days and Hours -->
                      <div class="days-hours-section">
                        <label>Business Hours</label>
                        <div class="days-selector">
                          <div 
                            class="day-selector" 
                            *ngFor="let day of daysOfWeek"
                            [class.selected]="isDaySelected(day.value)">
                            
                            <div class="day-header">
                              <p-checkbox 
                                [binary]="true"
                                [(ngModel)]="day.selected"
                                (onChange)="onDayToggle(day)">
                              </p-checkbox>
                              <span class="day-label">{{ day.label }}</span>
                            </div>
                            
                            <div class="time-inputs" *ngIf="day.selected">
                              <div class="time-input-group">
                                <label>Open</label>
                                <input 
                                  type="time" 
                                  [(ngModel)]="day.openTime"
                                  class="time-input">
                              </div>
                              <div class="time-input-group">
                                <label>Close</label>
                                <input 
                                  type="time" 
                                  [(ngModel)]="day.closeTime"
                                  class="time-input">
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </ng-template>
                  
                  <ng-template pTemplate="footer">
                    <div class="form-actions">
                      <p-button 
                        label="Cancel" 
                        severity="secondary" 
                        (onClick)="cancelScheduleForm()">
                      </p-button>
                      <p-button 
                        [label]="editingScheduleIndex !== null ? 'Update Schedule' : 'Save Schedule'"
                        (onClick)="saveCustomSchedule()">
                      </p-button>
                    </div>
                  </ng-template>
                </p-card>
              </div>

              <!-- Schedule Summary -->
              <div class="schedule-summary" *ngIf="businessSchedules.length > 0">
                <i class="pi pi-check-circle"></i>
                <span>{{ getScheduleSummary() }} ready for your customers</span>
              </div>
            </div>
          </div>

          <!-- Step 5: Service Assignment -->
          <div *ngIf="currentStep === 4" class="step-form">
            <div class="assignment-section">
              <h3><i class="pi pi-link"></i> Assign Services to Places</h3>
              <p>Drag and drop services to assign them to specific locations.</p>
              
              <div class="assignment-container">
                <!-- Unassigned Services -->
                <div class="unassigned-services">
                  <h4>Available Services</h4>
                  <div class="services-pool" 
                       cdkDropList 
                       id="services-pool"
                       [cdkDropListData]="unassignedServiceIds"
                       [cdkDropListConnectedTo]="placeDropListIds"
                       (cdkDropListDropped)="onServiceDrop($event, '')"
                       class="service-list">
                    <div *ngFor="let service of getUnassignedServices(); let i = index" 
                         class="service-item" 
                         cdkDrag 
                         [cdkDragData]="service.serviceID"
                         [attr.data-service-id]="service.serviceID"
                         [attr.data-service-name]="service.serviceName">
                      <p-card class="draggable-service">
                        <ng-template pTemplate="content">
                          <h5>{{ service.serviceName }}</h5>
                          <p>{{ service.serviceEstimatedTime }} • {{ service.servicePrice }} {{ service.servicePriceCurrencyUnit }}</p>
                        </ng-template>
                      </p-card>
                    </div>
                  </div>
                </div>

                <!-- Places with Service Assignment -->
                <div class="places-assignment">
                  <h4>Specific Address Locations</h4>
                  <div class="places-list">
                    <div *ngFor="let place of getSpecificLocationPlaces()" class="place-assignment">
                      <p-card class="place-card">
                        <ng-template pTemplate="header">
                          <div class="place-card-header">
                            <h5>{{ place.placeName }}</h5>
                            <p>{{ place.placeCity }}, {{ place.placeState }}</p>
                          </div>
                        </ng-template>
                        <ng-template pTemplate="content">
                          <div class="assigned-services"
                               cdkDropList
                               [id]="'assigned-services-' + place.placeID"
                               [cdkDropListData]="place.assignedServiceIDs"
                               [cdkDropListConnectedTo]="['services-pool']"
                               (cdkDropListDropped)="onServiceDrop($event, place.placeID)">
                            <div *ngFor="let service of getAssignedServices(place.placeID); let i = index" 
                                 class="assigned-service"
                                 cdkDrag
                                 [cdkDragData]="service.serviceID"
                                 [attr.data-service-id]="service.serviceID"
                                 [attr.data-service-name]="service.serviceName">
                              <p-chip 
                                [label]="service.serviceName"
                                [removable]="true"
                                (onRemove)="removeServiceFromPlace(service.serviceID!, place.placeID)"
                                styleClass="custom-chip-primary">
                              </p-chip>
                            </div>
                            <div *ngIf="getAssignedServices(place.placeID).length === 0" class="drop-zone">
                              Drop services here
                            </div>
                          </div>
                        </ng-template>
                      </p-card>
                    </div>
                  </div>

                  <h4>Area Specification Locations</h4>
                  <div class="places-list">
                    <div *ngFor="let place of getAreaSpecificationPlaces()" class="place-assignment">
                      <p-card class="place-card">
                        <ng-template pTemplate="header">
                          <div class="place-card-header">
                            <h5>{{ place.placeName }}</h5>
                            <p>{{ place.placeCity }}, {{ place.placeState }}</p>
                          </div>
                        </ng-template>
                        <ng-template pTemplate="content">
                          <div class="assigned-services"
                               cdkDropList
                               [id]="'assigned-services-' + place.placeID"
                               [cdkDropListData]="place.assignedServiceIDs"
                               [cdkDropListConnectedTo]="['services-pool']"
                               (cdkDropListDropped)="onServiceDrop($event, place.placeID)">
                            <div *ngFor="let service of getAssignedServices(place.placeID); let i = index" 
                                 class="assigned-service"
                                 cdkDrag
                                 [cdkDragData]="service.serviceID"
                                 [attr.data-service-id]="service.serviceID"
                                 [attr.data-service-name]="service.serviceName">
                              <p-chip 
                                [label]="service.serviceName"
                                [removable]="true"
                                (onRemove)="removeServiceFromPlace(service.serviceID!, place.placeID)"
                                styleClass="custom-chip-primary">
                              </p-chip>
                            </div>
                            <div *ngIf="getAssignedServices(place.placeID).length === 0" class="drop-zone">
                              Drop services here
                            </div>
                          </div>
                        </ng-template>
                      </p-card>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 6: Payment Setup (Stripe) -->
          <div *ngIf="currentStep === 5" class="step-form">
            <div class="stripe-section">
              <app-stripe-account-setup
                [businessEmail]="getBusinessEmail()"
                [businessName]="getBusinessName()"
                (stripeAccountCreated)="onStripeAccountCreated($event)"
                (skipStripeSetup)="onSkipStripeSetup()">
              </app-stripe-account-setup>
            </div>
          </div>

        </div>

        <!-- Registration Status -->
        <div class="registration-status mt-4" *ngIf="registrationError || isRegistering">
          <p-message 
            *ngIf="registrationError"
            severity="error" 
            [text]="registrationError">
          </p-message>
          
          <div class="registration-progress" *ngIf="isRegistering && !registrationError">
            <p-progressBar mode="indeterminate"></p-progressBar>
            <p>Registering your business...</p>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons mt-4">
          <p-button 
            label="Previous"
            icon="pi pi-arrow-left"
            severity="secondary"
            (onClick)="previousStep()" 
            [disabled]="currentStep === 0 || isRegistering">
          </p-button>
          
          <p-button 
            *ngIf="currentStep < maxSteps - 1 && currentStep !== 4"
            label="Next"
            icon="pi pi-arrow-right"
            iconPos="right"
            (onClick)="nextStep()" 
            [disabled]="isRegistering">
          </p-button>
          
          <p-button 
            *ngIf="currentStep === 4"
            label="Register Business"
            icon="pi pi-check"
            severity="success"
            [loading]="isSubmitting || isRegistering"
            (onClick)="onSubmit()">
          </p-button>
        </div>
      </ng-template>
    </p-card>
  </div>
</div>
