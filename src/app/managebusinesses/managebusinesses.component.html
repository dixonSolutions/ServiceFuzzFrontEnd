<div class="manage-businesses-container">
  <!-- Not Signed In Message -->
  <mat-card class="message-card" *ngIf="!data.currentUser">
    <mat-card-content class="message-content">
      <mat-icon class="message-icon">account_circle</mat-icon>
      <h2>Please Sign In</h2>
      <p>You need to be signed in to view your businesses.</p>
      <button mat-raised-button color="primary" [routerLink]="['/sign']" [queryParams]="{redirect: '/business/manage'}">
        <mat-icon>login</mat-icon>
        Sign In
      </button>
    </mat-card-content>
  </mat-card>

  <!-- Loading Spinner -->
  <mat-card class="message-card loading-card" *ngIf="data.currentUser && isLoading">
    <mat-card-content class="message-content">
      <mat-spinner diameter="48" color="primary"></mat-spinner>
      <h2>Loading Your Businesses</h2>
      <p>Please wait while we fetch your business information...</p>
    </mat-card-content>
  </mat-card>

  <!-- No Businesses Message -->
  <mat-card class="message-card" *ngIf="data.currentUser && !isLoading && (!allBusinesses || allBusinesses.length === 0)">
    <mat-card-content class="message-content">
      <mat-icon class="message-icon">business_center</mat-icon>
      <h2>No Businesses Found</h2>
      <p>You haven't registered any businesses yet.</p>
      <button mat-raised-button color="primary" routerLink="/business/add">
        <mat-icon>add_business</mat-icon>
        Add Your First Business
      </button>
    </mat-card-content>
  </mat-card>

  <!-- Businesses Grid -->
  <div class="businesses-grid" *ngIf="data.currentUser && !isLoading && allBusinesses && allBusinesses.length > 0">
    <h1 class="section-title">Your Businesses</h1>
    
    <!-- Search Bar -->
    <div class="search-container">
      <mat-form-field class="search-field" appearance="outline">
        <mat-label>Search businesses</mat-label>
        <input matInput 
               [(ngModel)]="searchQuery" 
               (input)="onSearchChange()"
               placeholder="Search by name, description, email, or phone"
               autocomplete="off">
        <mat-icon matPrefix>search</mat-icon>
        <button matSuffix 
                mat-icon-button 
                *ngIf="searchQuery" 
                (click)="clearSearch()"
                aria-label="Clear search">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
      
      <!-- Refresh Button -->
      <button mat-icon-button 
              (click)="refreshBusinesses()" 
              class="refresh-button"
              [disabled]="isLoading"
              matTooltip="Refresh businesses and payment status">
        <mat-icon>{{ isLoading ? 'hourglass_empty' : 'refresh' }}</mat-icon>
      </button>
    </div>

    <!-- Search Results Info -->
    <div class="search-results-info" *ngIf="searchQuery">
      <p>
        <span *ngIf="filteredBusinesses.length === 1">{{ filteredBusinesses.length }} business found</span>
        <span *ngIf="filteredBusinesses.length !== 1">{{ filteredBusinesses.length }} businesses found</span>
        for "{{ searchQuery }}"
      </p>
    </div>

    <!-- No Search Results -->
    <mat-card class="message-card no-results-card" *ngIf="searchQuery && filteredBusinesses.length === 0">
      <mat-card-content class="message-content">
        <mat-icon class="message-icon">search_off</mat-icon>
        <h3>No businesses found</h3>
        <p>No businesses match your search for "{{ searchQuery }}"</p>
        <button mat-button color="primary" (click)="clearSearch()">
          <mat-icon>clear</mat-icon>
          Clear search
        </button>
      </mat-card-content>
    </mat-card>
    
    <div class="grid-container" *ngIf="filteredBusinesses.length > 0">
      <mat-card class="business-card" *ngFor="let business of businessesToDisplay">
        <mat-card-header>
          <div mat-card-avatar class="business-avatar">
            <mat-icon>business</mat-icon>
          </div>
          <mat-card-title>{{business.basicInfo.businessName}}</mat-card-title>
          <mat-card-subtitle>{{business.basicInfo.email}}</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="business-info">
            <p class="description">{{business.basicInfo.businessDescription}}</p>
            <div class="contact-info">
              <p>
                <mat-icon>phone</mat-icon>
                {{business.basicInfo.phone}}
              </p>
              <p>
                <mat-icon>email</mat-icon>
                {{business.basicInfo.email}}
              </p>
            </div>
            <div class="business-stats">
              <p>
                <mat-icon>category</mat-icon>
                {{business.services?.length || 0}} Services
              </p>
              <p>
                <mat-icon>location_on</mat-icon>
                {{(business.specificAddresses?.length || 0) + (business.areaSpecifications?.length || 0)}} Locations
              </p>
              <p *ngIf="business.operationType === 'with_staff'">
                <mat-icon>people</mat-icon>
                {{business.staff?.length || 0}} Staff
              </p>
              <p class="stripe-status">
                <mat-icon 
                  *ngIf="isStripeAccountLoading(business.basicInfo.businessID)"
                  class="loading-icon">
                  hourglass_empty
                </mat-icon>
                <mat-icon 
                  *ngIf="!isStripeAccountLoading(business.basicInfo.businessID) && hasStripeAccount(business.basicInfo.businessID)"
                  class="stripe-icon has-stripe"
                  matTooltip="Payment processing enabled">
                  payment
                </mat-icon>
                <mat-icon 
                  *ngIf="!isStripeAccountLoading(business.basicInfo.businessID) && !hasStripeAccount(business.basicInfo.businessID)"
                  class="stripe-icon no-stripe"
                  matTooltip="Payment processing not set up">
                  payment_disabled
                </mat-icon>
                <span *ngIf="hasStripeAccount(business.basicInfo.businessID)">Payment Ready</span>
                <span *ngIf="!hasStripeAccount(business.basicInfo.businessID) && !isStripeAccountLoading(business.basicInfo.businessID)">Payment Setup Needed</span>
                <span *ngIf="isStripeAccountLoading(business.basicInfo.businessID)">Checking Payment Status...</span>
              </p>
            </div>
          </div>
        </mat-card-content>

        <mat-card-actions>
          <!-- Primary action buttons row -->
          <div class="primary-actions">
            <button mat-button color="primary" (click)="startEditing(business)">
              <mat-icon>edit</mat-icon>
              Edit
            </button>
            <button mat-button color="warn" (click)="deleteBusiness(business)">
              <mat-icon>delete</mat-icon>
              Delete
            </button>
            <button mat-button color="accent" (click)="viewBusinessDetails(business)">
              <mat-icon>visibility</mat-icon>
              View Details
            </button>
          </div>
        </mat-card-actions>
        
        <!-- Billing setup row - completely separate -->
        <div class="billing-setup-row" 
             *ngIf="!hasStripeAccount(business.basicInfo.businessID) && !isStripeAccountLoading(business.basicInfo.businessID)">
          <button mat-raised-button 
                  class="setup-billing-btn"
                  (click)="openBillingSetupDialog(business)">
            <mat-icon>payment</mat-icon>
            Set Up Payment Processing
          </button>
        </div>
      </mat-card>
    </div>
  </div>
</div>

<!-- BILLING SETUP DIALOG -->
<p-dialog 
  header="Set Up Billing for {{selectedBusiness?.basicInfo?.businessName}}" 
  [(visible)]="showBillingSetupDialog" 
  [modal]="true" 
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '500px', maxWidth: '90vw' }"
  (onHide)="closeBillingSetupDialog()">
  
  <div class="billing-setup-content" *ngIf="selectedBusiness">
    <div class="billing-info">
      <mat-icon class="billing-icon">account_balance</mat-icon>
      <h3>Connect Stripe Account</h3>
      <p>Set up payment processing for your business to accept online payments from customers.</p>
    </div>
    
    <form class="billing-form" [formGroup]="billingSetupForm" (ngSubmit)="submitBillingSetup()">
      <div class="form-group">
        <label for="businessEmail">Business Email *</label>
        <input 
          id="businessEmail"
          type="email" 
          pInputText 
          formControlName="businessEmail"
          placeholder="Enter business email for Stripe account"
          class="w-full"
          [class.error]="billingSetupForm.get('businessEmail')?.invalid && billingSetupForm.get('businessEmail')?.touched">
        <small class="error-message" 
               *ngIf="billingSetupForm.get('businessEmail')?.invalid && billingSetupForm.get('businessEmail')?.touched">
          Please enter a valid business email
        </small>
      </div>

      <div class="form-group">
        <label for="country">Country *</label>
        <p-dropdown
          id="country"
          [options]="countryOptions"
          formControlName="country"
          placeholder="Select country"
          optionLabel="label"
          optionValue="value"
          class="w-full"
          [class.error]="billingSetupForm.get('country')?.invalid && billingSetupForm.get('country')?.touched">
        </p-dropdown>
        <small class="error-message" 
               *ngIf="billingSetupForm.get('country')?.invalid && billingSetupForm.get('country')?.touched">
          Please select a country
        </small>
      </div>

      <div class="billing-features">
        <h4>What you'll get:</h4>
        <ul>
          <li><mat-icon>check_circle</mat-icon> Accept credit card payments</li>
          <li><mat-icon>check_circle</mat-icon> Automatic invoice generation</li>
          <li><mat-icon>check_circle</mat-icon> Real-time payment tracking</li>
          <li><mat-icon>check_circle</mat-icon> Secure payment processing</li>
        </ul>
      </div>

      <div class="form-actions">
        <button type="button" 
                pButton 
                label="Cancel" 
                icon="pi pi-times"
                class="p-button-outlined"
                (click)="closeBillingSetupDialog()"
                [disabled]="billingSetupLoading">
        </button>
        <button type="submit" 
                pButton 
                label="Set Up Billing" 
                icon="pi pi-credit-card"
                [loading]="billingSetupLoading"
                [disabled]="billingSetupForm.invalid || billingSetupLoading">
        </button>
      </div>
    </form>
  </div>
</p-dialog>
