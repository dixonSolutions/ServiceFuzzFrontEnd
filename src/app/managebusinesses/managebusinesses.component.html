<div class="manage-businesses-container">
  <!-- Not Signed In Message -->
  <mat-card class="message-card" *ngIf="!data.currentUser">
    <mat-card-content class="message-content">
      <mat-icon class="message-icon">account_circle</mat-icon>
      <h2>Please Sign In</h2>
      <p>You need to be signed in to view your businesses.</p>
      <button mat-raised-button color="primary" [routerLink]="['/sign']" [queryParams]="{redirect: '/business/manage'}">
        <mat-icon>login</mat-icon>
        Sign In
      </button>
    </mat-card-content>
  </mat-card>

  <!-- Loading Spinner -->
  <mat-card class="message-card loading-card" *ngIf="data.currentUser && isLoading">
    <mat-card-content class="message-content">
      <mat-spinner diameter="48" color="primary"></mat-spinner>
      <h2>Loading Your Businesses</h2>
      <p>Please wait while we fetch your business information...</p>
    </mat-card-content>
  </mat-card>

  <!-- No Businesses Message -->
  <mat-card class="message-card" *ngIf="data.currentUser && !isLoading && (!allBusinesses || allBusinesses.length === 0)">
    <mat-card-content class="message-content">
      <mat-icon class="message-icon">business_center</mat-icon>
      <h2>No Businesses Found</h2>
      <p>You haven't registered any businesses yet.</p>
      <button mat-raised-button color="primary" routerLink="/business/add">
        <mat-icon>add_business</mat-icon>
        Add Your First Business
      </button>
    </mat-card-content>
  </mat-card>

  <!-- Businesses Grid -->
  <div class="businesses-grid" *ngIf="data.currentUser && !isLoading && allBusinesses && allBusinesses.length > 0">
    <h1 class="section-title">Your Businesses</h1>
    
    <!-- Search Bar -->
    <div class="search-container">
      <mat-form-field class="search-field" appearance="outline">
        <mat-label>Search businesses</mat-label>
        <input matInput 
               [(ngModel)]="searchQuery" 
               (input)="onSearchChange()"
               placeholder="Search by name, description, email, or phone"
               autocomplete="off">
        <mat-icon matPrefix>search</mat-icon>
        <button matSuffix 
                mat-icon-button 
                *ngIf="searchQuery" 
                (click)="clearSearch()"
                aria-label="Clear search">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
      
      <!-- Refresh Button -->
      <button mat-icon-button 
              (click)="refreshBusinesses()" 
              class="refresh-button"
              [disabled]="isLoading"
              matTooltip="Refresh businesses and payment status">
        <mat-icon>{{ isLoading ? 'hourglass_empty' : 'refresh' }}</mat-icon>
      </button>
    </div>

    <!-- Search Results Info -->
    <div class="search-results-info" *ngIf="searchQuery">
      <p>
        <span *ngIf="filteredBusinesses.length === 1">{{ filteredBusinesses.length }} business found</span>
        <span *ngIf="filteredBusinesses.length !== 1">{{ filteredBusinesses.length }} businesses found</span>
        for "{{ searchQuery }}"
      </p>
    </div>

    <!-- No Search Results -->
    <mat-card class="message-card no-results-card" *ngIf="searchQuery && filteredBusinesses.length === 0">
      <mat-card-content class="message-content">
        <mat-icon class="message-icon">search_off</mat-icon>
        <h3>No businesses found</h3>
        <p>No businesses match your search for "{{ searchQuery }}"</p>
        <button mat-button color="primary" (click)="clearSearch()">
          <mat-icon>clear</mat-icon>
          Clear search
        </button>
      </mat-card-content>
    </mat-card>
    
    <div class="grid-container" *ngIf="filteredBusinesses.length > 0">
      <mat-card class="business-card" *ngFor="let business of businessesToDisplay">
        <mat-card-header>
          <div mat-card-avatar class="business-avatar">
            <mat-icon>business</mat-icon>
          </div>
          <mat-card-title>{{business.basicInfo.businessName}}</mat-card-title>
          <mat-card-subtitle>{{business.basicInfo.email}}</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="business-info">
            <p class="description">{{business.basicInfo.businessDescription}}</p>
            <div class="contact-info">
              <p>
                <mat-icon>phone</mat-icon>
                {{business.basicInfo.phone}}
              </p>
              <p>
                <mat-icon>email</mat-icon>
                {{business.basicInfo.email}}
              </p>
            </div>
            <div class="business-stats">
              <p>
                <mat-icon>category</mat-icon>
                {{business.services?.length || 0}} Services
              </p>
              <p>
                <mat-icon>location_on</mat-icon>
                {{(business.specificAddresses?.length || 0) + (business.areaSpecifications?.length || 0)}} Locations
              </p>
              <p *ngIf="business.operationType === 'with_staff'">
                <mat-icon>people</mat-icon>
                {{business.staff?.length || 0}} Staff
              </p>
              <p class="stripe-status">
                <mat-icon 
                  *ngIf="isStripeAccountLoading(business.basicInfo.businessID)"
                  class="loading-icon">
                  hourglass_empty
                </mat-icon>
                <mat-icon 
                  *ngIf="!isStripeAccountLoading(business.basicInfo.businessID) && hasStripeAccount(business.basicInfo.businessID)"
                  class="stripe-icon has-stripe"
                  matTooltip="Payment processing enabled">
                  payment
                </mat-icon>
                <mat-icon 
                  *ngIf="!isStripeAccountLoading(business.basicInfo.businessID) && !hasStripeAccount(business.basicInfo.businessID)"
                  class="stripe-icon no-stripe"
                  matTooltip="Payment processing not set up">
                  payment_disabled
                </mat-icon>
                <span *ngIf="hasStripeAccount(business.basicInfo.businessID)" 
                      class="payment-status-link payment-ready"
                      (click)="openBillingSetupDialog(business)"
                      matTooltip="Click to manage Stripe account">
                  Payment Ready
                </span>
                <span *ngIf="!hasStripeAccount(business.basicInfo.businessID) && !isStripeAccountLoading(business.basicInfo.businessID)"
                      class="payment-status-link payment-needed"
                      (click)="openBillingSetupDialog(business)"
                      matTooltip="Click to set up payment processing">
                  Payment Setup Needed
                </span>
                <span *ngIf="isStripeAccountLoading(business.basicInfo.businessID)">Checking Payment Status...</span>
              </p>
            </div>
          </div>
        </mat-card-content>

        <mat-card-actions>
          <!-- Primary action buttons row -->
          <div class="primary-actions">
            <button mat-button color="primary" (click)="startEditing(business)">
              <mat-icon>edit</mat-icon>
              Edit
            </button>
            <button mat-button color="warn" (click)="deleteBusiness(business)">
              <mat-icon>delete</mat-icon>
              Delete
            </button>
            <button mat-button color="accent" (click)="viewBusinessDetails(business)">
              <mat-icon>visibility</mat-icon>
              View Details
            </button>
          </div>
        </mat-card-actions>
        
        <!-- Billing setup row - completely separate -->
        <div class="billing-setup-row" 
             *ngIf="!hasStripeAccount(business.basicInfo.businessID) && !isStripeAccountLoading(business.basicInfo.businessID)">
          <button mat-raised-button 
                  class="setup-billing-btn"
                  (click)="openBillingSetupDialog(business)">
            <mat-icon>payment</mat-icon>
            Set Up Payment Processing
          </button>
        </div>
      </mat-card>
    </div>
  </div>
</div>

<!-- STRIPE ACCOUNT MANAGEMENT DIALOG -->
<p-dialog 
  [header]="getDialogHeader()" 
  [(visible)]="showBillingSetupDialog" 
  [modal]="true" 
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: showOnboardingIframe ? '90vw' : '600px', maxWidth: '95vw', height: showOnboardingIframe ? '90vh' : 'auto' }"
  (onHide)="closeBillingSetupDialog()">
  
  <div class="stripe-management-content" *ngIf="selectedBusiness">
    
    <!-- Operation Selection (for existing accounts) -->
    <div class="operation-selection" *ngIf="showOperationSelection && !showOnboardingIframe">
      <div class="current-account-info">
        <div class="account-status">
          <mat-icon class="status-icon connected">check_circle</mat-icon>
          <div class="status-text">
            <h4>Stripe Account Connected</h4>
            <p>Current email: <strong>{{currentStripeEmail}}</strong></p>
          </div>
        </div>
      </div>
      
      <div class="operation-options">
        <h4>What would you like to do?</h4>
        <div class="options-grid">
          <button type="button" 
                  pButton 
                  label="Update Account" 
                  icon="pi pi-pencil"
                  class="p-button-outlined option-btn"
                  (click)="setStripeOperation('update')"
                  [class.selected]="stripeOperation === 'update'">
            <small>Change email or country</small>
          </button>
          
          <button type="button" 
                  pButton 
                  label="Delete Account" 
                  icon="pi pi-trash"
                  class="p-button-outlined p-button-danger option-btn"
                  (click)="setStripeOperation('delete')">
            <small>Permanently remove Stripe integration</small>
          </button>
        </div>
        
        <div class="info-note">
          <small><strong>Note:</strong> Updating will automatically replace your current account. Deleting will permanently remove your Stripe integration.</small>
        </div>
      </div>
          </div>

    <!-- Create/Update Form -->
    <div class="account-form" *ngIf="(stripeOperation === 'create' || (stripeOperation === 'update' && !showOperationSelection)) && !showOnboardingIframe">
      <div class="form-header">
        <mat-icon class="form-icon">{{stripeOperation === 'create' ? 'add_card' : 'edit'}}</mat-icon>
        <h3>{{stripeOperation === 'create' ? 'Create Stripe Account' : 'Update Stripe Account'}}</h3>
        <p *ngIf="stripeOperation === 'create'">Set up payment processing for your business to accept online payments from customers.</p>
        <p *ngIf="stripeOperation === 'update'">Update your Stripe account details. This will create a new account with the updated information.</p>
      </div>
      
      <form class="billing-form" [formGroup]="billingSetupForm" (ngSubmit)="submitBillingSetup()">
        <div class="form-group">
          <label for="businessEmail">Business Email *</label>
          <input 
            id="businessEmail"
            type="email" 
            pInputText 
            formControlName="businessEmail"
            placeholder="Enter business email for Stripe account"
            class="w-full"
            [class.error]="billingSetupForm.get('businessEmail')?.invalid && billingSetupForm.get('businessEmail')?.touched">
          <small class="field-hint">This email will be used for Stripe notifications and account management</small>
          <small class="error-message" 
                 *ngIf="billingSetupForm.get('businessEmail')?.invalid && billingSetupForm.get('businessEmail')?.touched">
            Please enter a valid business email
          </small>
        </div>

        <div class="form-group">
          <label for="country">Country *</label>
          <p-dropdown
            id="country"
            [options]="countryOptions"
            formControlName="country"
            placeholder="Select country"
            optionLabel="label"
            optionValue="value"
            class="w-full"
            [class.error]="billingSetupForm.get('country')?.invalid && billingSetupForm.get('country')?.touched">
          </p-dropdown>
          <small class="field-hint">Select the country where your business is legally registered</small>
          <small class="error-message" 
                 *ngIf="billingSetupForm.get('country')?.invalid && billingSetupForm.get('country')?.touched">
            Please select a country
          </small>
        </div>

        <div class="billing-features" *ngIf="stripeOperation === 'create'">
          <h4>What you'll get:</h4>
          <ul>
            <li><mat-icon>check_circle</mat-icon> Accept credit card payments</li>
            <li><mat-icon>check_circle</mat-icon> Automatic invoice generation</li>
            <li><mat-icon>check_circle</mat-icon> Real-time payment tracking</li>
            <li><mat-icon>check_circle</mat-icon> Secure payment processing</li>
          </ul>
        </div>

        <div class="update-warning" *ngIf="stripeOperation === 'update'">
          <div class="warning-box">
            <mat-icon>info</mat-icon>
            <div>
              <strong>Important:</strong> Updating will delete your current Stripe account and create a new one. 
              You'll need to complete the onboarding process again.
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" 
                  pButton 
                  label="Cancel" 
                  icon="pi pi-times"
                  class="p-button-outlined"
                  (click)="closeBillingSetupDialog()"
                  [disabled]="billingSetupLoading">
          </button>
          
          <button type="button" 
                  pButton 
                  label="Back" 
                  icon="pi pi-arrow-left"
                  class="p-button-outlined"
                  (click)="goBackToOperationSelection()"
                  [disabled]="billingSetupLoading"
                  *ngIf="stripeOperation === 'update' && currentStripeEmail">
          </button>
          
          <button type="submit" 
                  pButton 
                  [label]="stripeOperation === 'create' ? 'Create Account' : 'Update Account'" 
                  icon="pi pi-credit-card"
                  [loading]="billingSetupLoading"
                  [disabled]="billingSetupForm.invalid || billingSetupLoading">
          </button>
        </div>
      </form>
    </div>

    <!-- Stripe Onboarding Link -->
    <div class="onboarding-link-section" *ngIf="showOnboardingIframe">
      <div class="success-content">
        <div class="success-icon">
          <mat-icon>check_circle</mat-icon>
        </div>
        <h3>Stripe Account Created Successfully!</h3>
        <p>Complete your Stripe onboarding to start accepting payments.</p>
        
        <div class="onboarding-info">
          <ul>
            <li>Verify your business information</li>
            <li>Add your bank account details</li>
            <li>Complete identity verification</li>
          </ul>
        </div>

        <div class="onboarding-actions">
          <button type="button" 
                  pButton 
                  label="Complete Stripe Setup"
                  icon="pi pi-external-link"
                  class="p-button-raised p-button-success"
                  (click)="openStripeOnboarding()">
          </button>
          
          <button type="button" 
                  pButton 
                  label="Do This Later"
                  icon="pi pi-clock"
                  class="p-button-outlined"
                  (click)="closeOnboardingIframe()">
          </button>
        </div>

        <div class="onboarding-note">
          <small>You can also complete this setup later from your business settings.</small>
        </div>
      </div>
    </div>

  </div>
</p-dialog>
