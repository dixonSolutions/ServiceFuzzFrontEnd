<p-toast></p-toast>
<div class="settings-container">
  <!-- Not Signed In Message -->
  <div class="auth-required-card" *ngIf="!data.currentUser">
    <p-card>
      <div class="auth-prompt">
        <i class="pi pi-user" style="font-size: 3rem; color: #3b82f6; margin-bottom: 1rem;"></i>
      <h2>Please Sign In</h2>
        <p>You need to be signed in to view your billing settings.</p>
        <p-button 
          label="Sign In" 
          icon="pi pi-sign-in" 
          [routerLink]="['/sign-in-or-sign-up']"
          styleClass="p-button-lg"
        ></p-button>
      </div>
    </p-card>
  </div>

  <!-- Main Content -->
  <div class="billing-content" *ngIf="data.currentUser">
    
    <!-- Error Display -->
    <p-messages 
      *ngIf="billingError" 
      severity="error" 
      [value]="[{severity: 'error', summary: 'Billing Error', detail: billingError.message}]"
      [closable]="true"
      (onClose)="dismissBillingError()"
    ></p-messages>

    <!-- Header Section -->
    <div class="page-header">
      <div class="header-content">
        <h1 class="page-title">
          <i class="pi pi-shopping-cart"></i>
          Choose Your Plan
        </h1>
        <p class="page-subtitle" *ngIf="!billingProfile">Select a plan to get started with ServiceFuzz. All plans include a free trial!</p>
        <p class="page-subtitle" *ngIf="billingProfile">Manage your subscription or switch to a different plan.</p>
      </div>
    </div>

    <!-- Current Plan Summary (if exists) -->
    <div class="current-plan-summary" *ngIf="billingProfile">
      <p-card styleClass="summary-card">
        <div class="summary-content">
          <div class="summary-header">
            <div class="summary-info">
              <div class="summary-title">
                <i class="pi pi-crown"></i>
                <span>Current Plan: <strong>{{ billingProfile.plan.name }}</strong></span>
              </div>
              <p-tag 
                [value]="getBillingStatusText(billingProfile.billingStatus)"
                [severity]="getBillingStatusSeverity(billingProfile.billingStatus)"
                styleClass="status-tag-large"
              ></p-tag>
            </div>
          </div>

          <div class="summary-details">
            <div class="summary-item">
              <i class="pi pi-money-bill"></i>
              <div>
                <label>Monthly Cost</label>
                <span>{{ formatCurrency(billingProfile.plan.basePrice, billingProfile.plan.currency) }}</span>
              </div>
            </div>
            
            <div class="summary-item">
              <i class="pi pi-briefcase"></i>
              <div>
                <label>Businesses</label>
                <span>{{ billingProfile.businessCount }}</span>
              </div>
            </div>
            
            <div class="summary-item" *ngIf="billingProfile.nextBillingDate">
              <i class="pi pi-calendar"></i>
              <div>
                <label>Next Billing</label>
                <span>{{ formatDate(billingProfile.nextBillingDate) }}</span>
              </div>
            </div>
            
            <div class="summary-item" *ngIf="billingProfile.trialEndsAt">
              <i class="pi pi-clock"></i>
              <div>
                <label>Trial Ends</label>
                <span [class.trial-warning]="isTrialExpiringSoon()">{{ formatDate(billingProfile.trialEndsAt) }}</span>
              </div>
            </div>
          </div>

          <!-- Trial Warning -->
          <p-message 
            *ngIf="isTrialExpiringSoon()" 
            severity="warn" 
            text="Your trial expires in {{ getDaysUntilTrialEnd() }} days. Subscribe below to continue using ServiceFuzz."
            styleClass="trial-warning-message"
          ></p-message>

          <!-- Quick Usage Overview -->
          <div class="quick-usage" *ngIf="usageSummary">
            <span><i class="pi pi-users"></i> {{ usageSummary.totalStaff }}/{{ usageSummary.includedStaff }} Staff</span>
            <span><i class="pi pi-desktop"></i> {{ usageSummary.totalWorkspaces }}/{{ usageSummary.includedWorkspaces }} Workspaces</span>
            <span><i class="pi pi-cloud-upload"></i> {{ usageSummary.totalDeployments }}/{{ usageSummary.includedDeployments }} Deployments</span>
          </div>
        </div>
      </p-card>
    </div>

    <!-- All Plans Section -->
    <div class="all-plans-section">
      <!-- Loading State -->
      <div *ngIf="isBillingLoading && availablePlans.length === 0" class="loading-state">
        <p-progressSpinner strokeWidth="4" animationDuration="1s"></p-progressSpinner>
        <p>Loading available plans...</p>
      </div>

      <!-- Plans Grid -->
      <div class="plans-grid" *ngIf="availablePlans.length > 0">
        <div 
          *ngFor="let plan of availablePlans" 
          class="plan-card-wrapper"
          [class.is-current]="billingProfile?.plan?.id === plan.id"
        >
          <!-- Current Plan Ribbon -->
          <div class="current-ribbon" *ngIf="billingProfile?.plan?.id === plan.id">
            <i class="pi pi-check"></i>
            <span>CURRENT</span>
          </div>

          <p-card styleClass="plan-card">
            <div class="plan-card-header">
              <h3 class="plan-name">{{ plan.name }}</h3>
              <div class="plan-price">
                <span class="price-amount">{{ formatCurrency(calculateTotalPrice(plan), plan.currency) }}</span>
                <span class="price-period">/month</span>
              </div>
            </div>

            <div class="plan-content">
              <!-- Business Count Selector (only for non-current plans) -->
              <div class="business-selector" *ngIf="plan.capabilities && billingProfile?.plan?.id !== plan.id">
                <label>Number of Businesses</label>
                <div class="business-counter">
                  <p-button 
                    icon="pi pi-minus" 
                    styleClass="p-button-sm p-button-outlined"
                    (onClick)="onBusinessCountChange(plan.id, (businessCounts[plan.id] || 1) - 1)"
                    [disabled]="(businessCounts[plan.id] || 1) <= 1"
                  ></p-button>
                  <span class="counter-display">{{ businessCounts[plan.id] || 1 }}</span>
                  <p-button 
                    icon="pi pi-plus" 
                    styleClass="p-button-sm p-button-outlined"
                    (onClick)="onBusinessCountChange(plan.id, (businessCounts[plan.id] || 1) + 1)"
                    [disabled]="(businessCounts[plan.id] || 1) >= plan.capabilities.maxTotalBusinesses"
                  ></p-button>
                </div>
                <small class="business-limit">Max: {{ plan.capabilities.maxTotalBusinesses }} businesses</small>
              </div>

              <!-- Plan Features -->
              <div class="plan-features">
                <div class="feature-item">
                  <i class="pi pi-check"></i>
                  <span>{{ plan.includedStaff }} staff members</span>
                </div>
                <div class="feature-item">
                  <i class="pi pi-check"></i>
                  <span>{{ plan.includedWorkspaces }} workspaces</span>
                </div>
                <div class="feature-item">
                  <i class="pi pi-check"></i>
                  <span>{{ plan.includedDeployments }} deployments/month</span>
                </div>
                <div class="feature-item" *ngIf="plan.capabilities">
                  <i class="pi pi-check"></i>
                  <span>{{ plan.capabilities.maxFreeBusinesses }} free business</span>
                </div>
                <div class="feature-item" *ngIf="plan.capabilities?.features?.teamCollaboration">
                  <i class="pi pi-check"></i>
                  <span>Team collaboration</span>
                </div>
                <div class="feature-item" *ngIf="plan.capabilities?.features?.emailServerHosting">
                  <i class="pi pi-check"></i>
                  <span>Email server hosting</span>
                </div>
                <div class="feature-item" *ngIf="plan.capabilities?.features?.advancedAnalytics">
                  <i class="pi pi-check"></i>
                  <span>Advanced analytics</span>
                </div>
                <div class="feature-item" *ngIf="plan.capabilities?.features?.prioritySupport">
                  <i class="pi pi-check"></i>
                  <span>Priority support</span>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="plan-actions">
                <!-- Current Plan + Trialing: Show Subscribe button -->
                <p-button 
                  *ngIf="billingProfile?.plan?.id === plan.id && billingProfile?.billingStatus === 'trialing'"
                  label="Subscribe Now" 
                  icon="pi pi-credit-card"
                  styleClass="p-button-lg p-button-success"
                  (onClick)="onSubscribeToPlan(plan)"
                  [loading]="isSubscribing"
                ></p-button>

                <!-- Current Plan + Active: Show active badge -->
                <div class="active-plan-indicator" *ngIf="billingProfile?.plan?.id === plan.id && billingProfile?.billingStatus !== 'trialing'">
                  <i class="pi pi-check-circle"></i>
                  <span>Active Subscription</span>
                </div>

                <!-- Other Plans + User has subscription: Show Switch button -->
                <p-button 
                  *ngIf="billingProfile?.plan?.id !== plan.id && billingProfile"
                  label="Switch to This Plan" 
                  icon="pi pi-sync"
                  styleClass="p-button-lg p-button-outlined switch-btn"
                  (onClick)="onSubscribeToPlan(plan)"
                  [loading]="isSubscribing"
                ></p-button>

                <!-- Other Plans + No subscription: Show Trial + Subscribe buttons -->
                <ng-container *ngIf="!billingProfile">
                  <p-button 
                    label="Try Free Trial" 
                    icon="pi pi-play"
                    styleClass="p-button-lg trial-btn"
                    (onClick)="onStartTrial(plan)"
                    [loading]="isSubscribing"
                  ></p-button>
                  
                  <p-button 
                    label="Subscribe Now" 
                    icon="pi pi-credit-card"
                    styleClass="p-button-lg p-button-outlined subscribe-btn-outlined"
                    (onClick)="onSubscribeToPlan(plan)"
                    [loading]="isSubscribing"
                  ></p-button>
                </ng-container>
              </div>
            </div>
          </p-card>
        </div>
      </div>

      <!-- No Plans Available -->
      <div *ngIf="!isBillingLoading && availablePlans.length === 0" class="no-plans-state">
        <p-card>
          <div class="no-plans-content">
            <i class="pi pi-info-circle" style="font-size: 3rem; color: #6b7280; margin-bottom: 1rem;"></i>
            <h3>No Plans Available</h3>
            <p>Unable to load available plans. Please try refreshing the page.</p>
            <p-button 
              label="Refresh" 
              icon="pi pi-refresh"
              (onClick)="refreshBillingData()"
            ></p-button>
          </div>
        </p-card>
      </div>
    </div>
  </div>
</div>
