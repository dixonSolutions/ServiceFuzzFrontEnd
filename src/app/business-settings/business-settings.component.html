<p-toast></p-toast>
<div class="settings-container">
  <!-- Not Signed In Message -->
  <mat-card class="message-card" *ngIf="!data.currentUser">
    <mat-card-content class="message-content">
      <mat-icon class="message-icon">account_circle</mat-icon>
      <h2>Please Sign In</h2>
      <p>You need to be signed in to view your business settings.</p>
      <button mat-raised-button color="primary" [routerLink]="['/sign']" [queryParams]="{redirect: '/business/settings'}">
        <mat-icon>login</mat-icon>
        Sign In
      </button>
    </mat-card-content>
  </mat-card>

  <!-- Subscription Status -->
  <div class="subscription-section" *ngIf="data.currentUser">
    <p-card class="subscription-card" [header]="'Subscription'" [subheader]="isTrialing ? 'Trialing' : (isActiveSubscribedNoTrial ? 'Active' : (hasNoSubscription ? 'Not Subscribed' : ''))">
        <div class="subscription-info" *ngIf="subscriptionStatus && !isLoadingSubscription">
          <!-- State 1: Subscribed + trialing -->
          <ng-container *ngIf="isTrialing">
            <div class="info-row">
              <span>You are on a free trial. If you don't cancel, you will be charged automatically at the end of the trial.</span>
            </div>
            <div class="info-row" *ngIf="subscriptionStatus.currentPeriodEnd">
              <span>Trial ends: {{ subscriptionStatus.currentPeriodEnd | date:'mediumDate' }}</span>
            </div>
            <div class="subscribe-options">
              <button pButton type="button" class="p-button-outlined p-button-danger" label="Cancel Trial" (click)="cancelTrialLocally()"></button>
            </div>
          </ng-container>

          <!-- State 2: Subscribed, no trial -->
          <ng-container *ngIf="isActiveSubscribedNoTrial">
            <div class="info-row">
              <span>You are subscribed.</span>
            </div>
            <div class="info-row" *ngIf="subscriptionStatus.currentPeriodEnd">
              <span>Renews on: {{ subscriptionStatus.currentPeriodEnd | date:'mediumDate' }}</span>
            </div>
            <div class="subscribe-options">
              <button pButton type="button" class="p-button-outlined p-button-danger" label="Unsubscribe" (click)="unsubscribeLocally()"></button>
            </div>
          </ng-container>

          <!-- State 3: No subscription or trial -->
          <ng-container *ngIf="hasNoSubscription">
            <div class="upgrade-prompt">
              <h4>Choose how to subscribe</h4>
              <div class="subscribe-options">
                <button pButton type="button" [label]="isSubscribing ? 'Redirecting...' : 'Start 30-day free trial'" (click)="startStripeTrial()" [disabled]="isSubscribing"></button>
                <button pButton type="button" class="p-button-warning" [label]="isSubscribing ? 'Redirecting...' : 'Subscribe Now'" (click)="upgradeToPremium()" [disabled]="isSubscribing"></button>
              </div>
            </div>
          </ng-container>
        </div>

        <!-- Loading State -->
        <div class="loading-subscription" *ngIf="isLoadingSubscription">
          <p-progressSpinner styleClass="w-3rem h-3rem" strokeWidth="6"></p-progressSpinner>
          <p>Checking subscription status...</p>
        </div>
    </p-card>
  </div>

  <!-- Legacy free trial and marketing content removed per new subscription UX -->
