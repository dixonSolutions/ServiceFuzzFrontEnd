<!-- Toast notifications -->
<p-toast />

<!-- Main auth container -->
<div class="auth-container">
  <!-- Profile Display for authenticated users -->
  <p-card class="profile-card" *ngIf="isAuthenticated && serviceFuzzUser">
    <ng-template pTemplate="header">
      <div class="profile-header">
        <div class="profile-avatar">
          <img *ngIf="userInfo && userInfo.picture" [src]="userInfo.picture" [alt]="serviceFuzzUser.name || ''" class="profile-image">
          <div *ngIf="!userInfo || !userInfo.picture" class="letter-avatar">
            {{ getFirstLetter(serviceFuzzUser.name) }}
          </div>
        </div>
        <div class="profile-info">
          <h2 class="profile-title">Welcome back!</h2>
          <h3 class="profile-name">{{serviceFuzzUser.name}}</h3>
          <p class="profile-email">{{serviceFuzzUser.email}}</p>
        </div>
      </div>
    </ng-template>
    
    <div class="profile-actions">
      <p-button 
        label="Go to Dashboard" 
        icon="pi pi-home" 
        routerLink="/home"
        styleClass="p-button-lg p-button-success w-full mb-3">
      </p-button>
      <p-button 
        label="Sign Out" 
        icon="pi pi-sign-out" 
        (onClick)="signOut()"
        styleClass="p-button-lg p-button-outlined w-full">
      </p-button>
    </div>
  </p-card>

  <!-- Auto Sign-In Loading Card -->
  <p-card class="auth-card loading-card" *ngIf="isAutoSignInLoading">
    <ng-template pTemplate="header">
      <div class="auth-header">
        <div class="logo-section">
          <i class="pi pi-shield" style="font-size: 2.5rem; color: #3b82f6;"></i>
        </div>
        <h1 class="auth-title">Restoring Session</h1>
        <p class="auth-subtitle">Please wait while we sign you back in...</p>
      </div>
    </ng-template>
    
    <div class="loading-content">
      <p-progressSpinner styleClass="w-4rem h-4rem" strokeWidth="4"></p-progressSpinner>
      <p class="loading-text">Checking your saved session...</p>
    </div>
  </p-card>

  <!-- Auth Card for non-authenticated users -->
  <p-card class="auth-card" *ngIf="!isAuthenticated && !isAutoSignInLoading">
    <ng-template pTemplate="header">
      <div class="auth-header">
        <div class="logo-section">
          <i class="pi pi-shield" style="font-size: 2.5rem; color: #3b82f6;"></i>
        </div>
        <h1 class="auth-title">{{ isSignIn ? 'Welcome Back' : 'Join ServiceFuzz' }}</h1>
        <p class="auth-subtitle">{{ isSignIn ? 'Sign in to your account' : 'Create your account to get started' }}</p>
      </div>
    </ng-template>

    <!-- Auth Form -->
    <form [formGroup]="authForm" (ngSubmit)="sendMagicLink()" class="auth-form">
      <!-- Email Input -->
      <div class="form-field">
        <p-floatlabel>
          <input 
            pInputText 
            id="email"
            formControlName="email" 
            class="w-full"
            autocomplete="off"
            [class.p-invalid]="authForm.get('email')?.invalid && authForm.get('email')?.touched && !isAuthenticated">
          <label for="email">Email Address</label>
        </p-floatlabel>
        <small 
          class="p-error block" 
          *ngIf="authForm.get('email')?.hasError('required') && authForm.get('email')?.touched && !isAuthenticated">
          Email is required
        </small>
        <small 
          class="p-error block" 
          *ngIf="authForm.get('email')?.hasError('email') && authForm.get('email')?.touched && !isAuthenticated">
          Please enter a valid email address
        </small>
      </div>

      <!-- Auto Sign-In Checkbox -->
      <div class="form-field auto-signin-field">
        <p-checkbox 
          formControlName="autoSignIn"
          inputId="autoSignIn"
          [binary]="true"
          (onChange)="onAutoSignInChange()">
        </p-checkbox>
        <label for="autoSignIn" class="auto-signin-label">
          Keep me signed in
          
        </label>
      </div>

      <!-- Magic Link Button -->
      <div class="form-actions">
        <p-button 
          [label]="isMagicLinkLoading ? (isSignIn ? 'Sending Magic Link...' : 'Creating Account...') : (isSignIn ? 'Send Magic Link' : 'Create Account')" 
          type="submit"
          [disabled]="!authForm.valid || isLoading || isMagicLinkLoading"
          [loading]="isMagicLinkLoading"
          styleClass="p-button-lg w-full">
        </p-button>
      </div>
    </form>

    <!-- Divider -->
    <div class="divider">
      <p-divider align="center" type="solid">
        <span class="divider-text">OR</span>
      </p-divider>
    </div>

    <!-- Google Sign-In -->
    <div class="social-login">
      <div class="google-signin-container" *ngIf="!isGoogleLoading">
        <!-- Google Sign-In button will be initialized here by TypeScript -->
      </div>
      
      <!-- Google Loading State -->
      <div class="google-loading" *ngIf="isGoogleLoading">
        <p-button 
          label="Signing in with Google..." 
          icon="pi pi-google"
          [loading]="true"
          disabled="true"
          styleClass="p-button-lg w-full google-button">
        </p-button>
      </div>
    </div>

    <!-- Toggle Mode -->
    <div class="toggle-mode">
      <p class="toggle-text">
        {{ isSignIn ? "Don't have an account?" : 'Already have an account?' }}
        <a class="toggle-link" (click)="toggleMode()">
          {{ isSignIn ? 'Create Account' : 'Sign In' }}
        </a>
      </p>
    </div>

    <!-- Legal Links -->
    <ng-template pTemplate="footer">
      <div class="legal-links">
        <p class="legal-text">
          By {{ isSignIn ? 'signing in' : 'creating an account' }}, you agree to our 
          <a routerLink="/terms-of-use" class="legal-link">Terms of Use</a> 
          and 
          <a routerLink="/privacy-policy" class="legal-link">Privacy Policy</a>
        </p>
      </div>
    </ng-template>
  </p-card>
</div>