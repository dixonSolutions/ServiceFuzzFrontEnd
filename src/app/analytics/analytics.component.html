
<div class="analytics-container">
  <!-- Header Section -->
  <div class="analytics-header">
    <div class="header-content">
      <h1 class="m3-headline">Business Analytics Dashboard</h1>
      <p class="m3-body-large">Your command center for business intelligence and performance insights</p>
    </div>
    <div class="header-actions">
      <!-- Business Selection -->
      <div class="business-selection-container">
        <label class="business-selection-label m3-label-large">
          <mat-icon>business</mat-icon>
          Select Businesses
        </label>
        <div class="business-selection-controls">
          <p-multiselect 
            [options]="availableBusinesses" 
            [ngModel]="businessSelectionState.selectedBusinessIds"
            (ngModelChange)="onBusinessSelectionChange($event)"
            optionLabel="businessName" 
            optionValue="businessId"
            placeholder="Select businesses to analyze"
            [showToggleAll]="true"
            [showClear]="true"
            [showHeader]="true"
            [loading]="loadingState.isLoadingBusinesses"
            styleClass="business-multiselect">
            <ng-template #selectedItems>
              <div class="selected-business-summary">
                <span *ngIf="businessSelectionState.isAllSelected; else specificSelection">
                  All Businesses ({{ businessSelectionState.allBusinesses.length }})
                </span>
                <ng-template #specificSelection>
                  {{ businessSelectionState.selectedBusinessIds.length }} of {{ businessSelectionState.allBusinesses.length }} businesses
                </ng-template>
              </div>
            </ng-template>
          </p-multiselect>
          <button 
            mat-icon-button 
            class="refresh-businesses-btn" 
            (click)="refreshBusinessList()"
            [disabled]="loadingState.isLoadingBusinesses"
                         matTooltip="Refresh business list">
            <mat-icon>refresh</mat-icon>
          </button>
        </div>
        
        <!-- Business Selection Error -->
        <div *ngIf="loadingState.businessSelectionError" class="business-selection-error">
          <mat-icon>error_outline</mat-icon>
          {{ loadingState.businessSelectionError }}
        </div>
      </div>

      <button mat-button="elevated" class="refresh-btn m3-button" (click)="refreshData()">
        <mat-icon>refresh</mat-icon>
        Refresh Data
      </button>
    </div>
  </div>

  <!-- Top Section - Key Performance Indicators (KPIs) -->
  <div class="kpi-section">
    <div class="section-header">
      <h2 class="section-title m3-headline-small">Key Performance Indicators</h2>
      <div class="business-selection-indicator" *ngIf="!businessSelectionState.isAllSelected">
        <mat-icon>filter_list</mat-icon>
        <span class="m3-body-medium">
          Showing {{ businessSelectionState.selectedBusinessIds.length }} of {{ businessSelectionState.allBusinesses.length }} businesses
        </span>
        <button mat-button (click)="onSelectAllBusinesses()" class="show-all-btn">
          <mat-icon>visibility</mat-icon>
          Show All
        </button>
      </div>
    </div>
    <div class="kpi-grid">
      <!-- Loading State -->
      <div *ngIf="loadingState.isLoading" class="loading-container">
        <mat-card class="loading-card m3-card">
          <div class="loading-content">
            <mat-spinner></mat-spinner>
            <p class="m3-body-large">Loading analytics data...</p>
          </div>
        </mat-card>
      </div>

      <!-- Error State -->
      <div *ngIf="loadingState.hasError" class="error-container">
        <mat-card class="error-card m3-card">
          <div class="error-content">
            <mat-icon class="error-icon">error</mat-icon>
            <h3 class="m3-headline-small">Error Loading Analytics</h3>
            <p class="m3-body-medium">{{ loadingState.errorMessage }}</p>
            <button mat-raised-button color="primary" (click)="refreshData()">
              <mat-icon>refresh</mat-icon>
              Try Again
            </button>
          </div>
        </mat-card>
      </div>

      <!-- Data State -->
      <ng-container *ngIf="!loadingState.isLoading && !loadingState.hasError">
        <!-- Revenue KPI -->
        <mat-card class="kpi-card revenue m3-card">
          <div class="kpi-content">
            <div class="kpi-icon">
              <mat-icon>trending_up</mat-icon>
            </div>
            <div class="kpi-details">
              <div class="kpi-value m3-headline-medium">
                ${{ analyticsSummary.totalRevenue | number:'1.0-0' }}
              </div>
              <div class="kpi-label m3-label-large">Total Revenue</div>
              <div class="kpi-trend positive">
                <mat-icon>arrow_upward</mat-icon>
                {{ analyticsData.length }} businesses
              </div>
            </div>
          </div>
        </mat-card>

        <!-- Orders KPI -->
        <mat-card class="kpi-card appointments m3-card">
          <div class="kpi-content">
            <div class="kpi-icon">
              <mat-icon>event</mat-icon>
            </div>
            <div class="kpi-details">
              <div class="kpi-value m3-headline-medium">{{ analyticsSummary.totalOrders | number }}</div>
              <div class="kpi-label m3-label-large">Total Orders</div>
              <div class="kpi-trend positive">
                <mat-icon>arrow_upward</mat-icon>
                Across all businesses
              </div>
            </div>
          </div>
        </mat-card>

        <!-- Businesses KPI -->
        <mat-card class="kpi-card customers m3-card">
          <div class="kpi-content">
            <div class="kpi-icon">
              <mat-icon>people</mat-icon>
            </div>
            <div class="kpi-details">
              <div class="kpi-value m3-headline-medium">{{ analyticsSummary.totalBusinesses }}</div>
              <div class="kpi-label m3-label-large">Active Businesses</div>
              <div class="kpi-trend positive">
                <mat-icon>arrow_upward</mat-icon>
                Currently tracked
              </div>
            </div>
          </div>
        </mat-card>

        <!-- Activity Score KPI -->
        <mat-card class="kpi-card satisfaction m3-card">
          <div class="kpi-content">
            <div class="kpi-icon">
              <mat-icon>star</mat-icon>
            </div>
            <div class="kpi-details">
              <div class="kpi-value m3-headline-medium">{{ analyticsSummary.averageActivityScore | number:'1.1-1' }}</div>
              <div class="kpi-label m3-label-large">Avg. Activity Score</div>
              <div class="kpi-trend neutral">
                <mat-icon>remove</mat-icon>
                Performance metric
              </div>
            </div>
          </div>
        </mat-card>

        <!-- Empty State -->
        <div *ngIf="analyticsData.length === 0" class="empty-state">
          <mat-card class="empty-card m3-card">
            <div class="empty-content">
              <mat-icon class="empty-icon">analytics</mat-icon>
              <h3 class="m3-headline-small">No Analytics Data Available</h3>
              <p class="m3-body-medium">No business analytics data found. Make sure you have businesses registered and some order activity.</p>
              <button mat-raised-button color="primary" (click)="refreshData()">
                <mat-icon>refresh</mat-icon>
                Refresh Data
              </button>
            </div>
          </mat-card>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Middle Section - Primary Charts -->
  <div class="primary-charts-section">
    <h2 class="section-title m3-headline-small">Performance Analytics</h2>
    <div class="charts-grid primary">
      <!-- Revenue Trends -->
      <mat-card class="chart-card large m3-card">
        <mat-card-header>
          <mat-card-title class="m3-title-large">Revenue Trends</mat-card-title>
          <mat-card-subtitle class="m3-body-medium">Daily revenue performance over time</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #lineChartCanvas></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Appointment Volume -->
      <mat-card class="chart-card m3-card">
        <mat-card-header>
          <mat-card-title class="m3-title-large">Appointment Volume</mat-card-title>
          <mat-card-subtitle class="m3-body-medium">Booking patterns by day of week</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #barChartCanvas></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Service Performance -->
      <mat-card class="chart-card m3-card">
        <mat-card-header>
          <mat-card-title class="m3-title-large">Service Performance</mat-card-title>
          <mat-card-subtitle class="m3-body-medium">Most popular services ranking</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #horizontalBarCanvas></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Customer Acquisition -->
      <mat-card class="chart-card m3-card">
        <mat-card-header>
          <mat-card-title class="m3-title-large">Customer Acquisition</mat-card-title>
          <mat-card-subtitle class="m3-body-medium">New vs returning customers</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #pieChartCanvas></canvas>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Bottom Section - Detailed Insights -->
  <div class="detailed-insights-section">
    <h2 class="section-title m3-headline-small">Detailed Insights</h2>
    <div class="insights-grid">
      <!-- Customer Behavior -->
      <mat-card class="insight-card m3-card">
        <mat-card-header>
          <mat-card-title class="m3-title-large">Customer Behavior</mat-card-title>
          <mat-card-subtitle class="m3-body-medium">Demographics and booking patterns</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #doughnutChartCanvas></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Staff Performance -->
      <mat-card class="insight-card m3-card">
        <mat-card-header>
          <mat-card-title class="m3-title-large">Staff Performance</mat-card-title>
          <mat-card-subtitle class="m3-body-medium">Productivity and ratings analysis</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #radarChartCanvas></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Operational Efficiency -->
      <mat-card class="insight-card m3-card">
        <mat-card-header>
          <mat-card-title class="m3-title-large">Operational Efficiency</mat-card-title>
          <mat-card-subtitle class="m3-body-medium">Utilization rates and peak hours</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #heatmapCanvas></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Financial Breakdown -->
      <mat-card class="insight-card m3-card">
        <mat-card-header>
          <mat-card-title class="m3-title-large">Financial Breakdown</mat-card-title>
          <mat-card-subtitle class="m3-body-medium">Payment methods and revenue distribution</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #polarAreaChartCanvas></canvas>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Quick Actions Section -->
  <div class="quick-actions-section">
    <mat-card class="actions-card m3-card">
      <mat-card-header>
        <mat-card-title class="m3-title-large">Quick Actions</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="actions-grid">
          <button mat-button="elevated" class="action-btn m3-button" (click)="exportReport()">
            <mat-icon>download</mat-icon>
            Export Report
          </button>
          <button mat-button="outlined" class="action-btn m3-button" (click)="printDashboard()">
            <mat-icon>print</mat-icon>
            Print Dashboard
          </button>
          <button mat-button="outlined" class="action-btn m3-button" (click)="refreshData()">
            <mat-icon>refresh</mat-icon>
            Refresh Analytics
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>